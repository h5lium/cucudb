<form id="form-modify">
	<legend>Modify My Account</legend>
	
	<div class="control-group">
		<label>DB Name</label>
		<div class="controls">
			<input type="text" name="username">
		</div>
	</div>
	
	<div class="control-group">
		<label>Password</label>
		<div class="controls">
			<input type="password" name="password">
		</div>
	</div>
	<div class="control-group">
		<label>Password Again</label>
		<div class="controls">
			<input type="password" id="input-again">
		</div>
	</div>
	
	<div class="control-group">
		<label>Summary</label>
		<div class="controls">
			<textarea name="summary" rows="4" cols="30"></textarea>
		</div>
	</div>
	
	 <div class="control-group">
		<div class="controls">
			<input type="button" id="btn-drop" value="Drop">
			<input type="reset" value="Reset">
			<input type="submit" value="Modify">
		</div>
	</div>
</form>


<table id="table-collections">
	<caption>Collections</caption>
	<thead>
		<tr>
			<th>Name</th>
			<th>Fields</th>
			<th>Summary</th>
			<th>Action</th>
		</tr>
	</thead>
	<tbody></tbody>
	<tfoot>
		<tr>
			<td colspan="4">
				<button id="btn-create">Create</button>
			</td>
		</tr>
	</tfoot>
</table>



<hr>
<a href="/">Back</a>

<script src="/plug/jquery/jquery.min.js"></script>
<script src="/plug/underscore/underscore-min.js"></script>
<script src="/js/form.js"></script>
<script>
	$(document).ready(function(){
		// load data
		var $table = $('#table-collections');
		
		$.get('/do_check_db', function(reply){
			if (reply['ok']) {
				var db = reply['db'];
				var $tbody = $table.find('tbody').hide();
				$.each(db['_colls'], function(i, coll){
					$(['<tr>',
						'<td>'+ coll['name'] +'</td>',
						'<td>'+ coll['fields'] +'</td>',
						'<td>'+ coll['summary'] +'</td>',
						'<td>'+ '<a href="/check_coll/?coll='+ coll['name'] +'">详细</a>' +'</td>',
					'</tr>'].join('')).appendTo($tbody);
				});
				$tbody.show();
				
				// set default values
				$form.find('[name="username"]').attr('value', db['username']);
				$form.find('[name="summary"]').text(db['summary']);
			} else {
				alert(reply['msg']);
			}
		});
		
		
		// button create
		$table.find('#btn-create').on('click', function(ev){
			location.href = '/create_coll/';
		});
		
		
		//form submit
		var $form = $('#form-modify');
		$form.find('#btn-drop').on('click', function(){
			$.post('/do_drop', function(reply){
				alert(reply['msg']);
				
				if (reply['ok']) {
					location.href = '/';
				}
			});
		});
		$form.on('submit', function(ev){
			if (! validate()) {
				return false;
			}
			
			$.post('/do_modify_db', $form.getFormData(), function(reply){
				alert(reply['msg']);
				
				if (reply['ok']) {
					location.reload();
				}
			});
			
			return false;
			
			function validate(){
				var pass = $form.find('[name="password"]').val(),
					pass_again = $form.find('#input-again').val();
				if (pass && pass_again !== pass) {
					alert('Not Match');
					return false;
				}
				return true;
			}
		});
	});
</script>