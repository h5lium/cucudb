<div id="wrapper">
	<div class="block">
		<form id="form-remove">
			<table id="table-records" class="table table-striped">
				<caption></caption>
				<thead></thead>
				<tbody></tbody>
				<tfoot>
					<tr>
						<td class="td-master" colspan="1">
							<input type="submit" value="Remove" class="btn btn-danger">
						</td>
					</tr>
				</tfoot>
			</table>
		</form>
	</div>
	
	<div class="block">
		<form id="form-add" class="form-horizontal">
			<legend>Add A Record</legend>
			<div class="control-group">
				<input type="submit" value="Add" class="btn btn-success">
			</div>
		</form>
	</div>
</div>



<script>
	(function(){
		// load data
		var $wrapper = $('#wrapper'),
			$table_records = $wrapper.find('#table-records'),
			$form_remove = $wrapper.find('#form-remove'),
			$form_add = $wrapper.find('#form-add');
		
		var coll_name = $frame.getParam('coll');
		
		$table_records.find('caption').text('Records Of `' + coll_name + '`');
		
		$.get('/do_check_coll/?coll='+ coll_name, function(reply){
			if (reply['ok']) {
				var fields = reply['fields'],
					records = reply['_records'];
				
				$table_records.find('.td-master').attr('colspan', 1 + fields.length);
				
				var $thead = $table_records.find('thead'),
					$tr = $('<tr>').append(['<th>',
						'<input type="checkbox" class="check-all" data-name="_ids[]">',
					'</th>'].join(''));
				var $values = $form_add.find('#values');
				_.each(fields, function(field){
					$('<th>').text(field).appendTo($tr);
					
					// values
					var sys = ['_id'];
					if (! _.contains(sys, field)) {
						$(['<div class="control-group">',
							'<label class="control-label">'+ field +'</label>',
							'<div class="controls">',
								'<input type="text" name="values[]">',
							'</div>',
						'</div>'].join('')).insertBefore('#form-add>.control-group:last');
					}
				});
				$tr.appendTo($thead);
				
				var $tbody = $table_records.find('tbody').hide();
				_.each(records, function(record){
					var $tr = $('<tr>').append(['<td>', 
							'<input type="checkbox" name="_ids[]" value="'+ record['_id'] +'">',
						'</td>'].join(''));
					_.each(fields, function(field){
						$('<td>').text(record[field]).appendTo($tr);
					});
					$tr.appendTo($tbody);
				});
				$tbody.show();
			} else {
				$.notify(reply['msg']);
			}
		});
		
		
		//form submit
		$form_remove.on('submit', function(ev){
			$.post('/do_remove_records/?coll='+ coll_name,
				$form_remove.getFormData(), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.repath();
				}
			});
			
			return false;
		});
		
		$form_add.on('submit', function(ev){
			$.post('/do_add_record/?coll='+ coll_name,
				$form_add.getFormData(), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.repath();
				}
			});
			
			return false;
		});
	})();
</script>