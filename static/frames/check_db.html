
<style scoped>
	#div-fields>.input-group {
		margin-bottom: 6px;
	}
	
	#table-collections input {
		margin-bottom: 0;
	}
	#table-collections tr th,
	#table-collections tr td {
		vertical-align: middle;
	}
</style>


<div id="wrapper">
	
	<div class="panel panel-info">
		<div class="panel-heading">
			Modify My DB
		</div>
		
		<div class="panel-body">
			<form id="form-modify-db" class="form-horizontal">
				<div class="form-group">
					<label class="control-label col-sm-4">DB Name</label>
					<div class="col-sm-5">
						<input class="form-control" type="text" name="username" readonly>
					</div>
				</div>
				
				<div class="form-group">
					<label class="control-label col-sm-4">New Password</label>
					<div class="col-sm-5">
						<input class="form-control" type="password" name="password">
					</div>
				</div>
				<div class="form-group">
					<label class="control-label col-sm-4">New Password Again</label>
					<div class="col-sm-5">
						<input class="form-control" type="password" id="input-again">
					</div>
				</div>
				
				<div class="form-group">
					<label class="control-label col-sm-4">Summary</label>
					<div class="col-sm-5">
						<textarea class="form-control" name="summary"></textarea>
					</div>
				</div>
				
				 <div class="form-group">
				 	<div class="col-sm-12">
						<input type="reset" value="Reset" class="btn btn-default">
						<input type="submit" value="Modify" class="btn btn-info">
					</div>
				</div>
			</form>
		</div>
	</div>
	
	<div class="panel panel-default">
		<div class="panel-heading">
			My Collections
		</div>
		
		<div class="panel-body">
			<div class="table-responsive">
				<form id="form-colls">
					<table id="table-collections" class="table table-striped">
						<thead>
							<tr>
								<th>
									<input class="check-all" type="checkbox" data-name="selected[]">
								</th>
								<th>_id</th>
								<th>Name</th>
								<th>Fields</th>
								<th>Summary</th>
								<th>Action</th>
							</tr>
						</thead>
						<tbody></tbody>
						<tfoot>
							<tr>
								<td colspan="6">
									<input type="button" id="btn-remove-colls" class="btn btn-danger" value="Remove">
									<input type="reset" class="btn btn-default" value="Reset">
									<input type="button" id="btn-modify-colls" class="btn btn-info" value="Modify">
								</td>
							</tr>
						</tfoot>
					</table>
				</form>
			</div>
		</div>
	</div>
	
	
	<div class="panel panel-success">
		<div class="panel-heading">
			Add Collection
		</div>
		
		<div class="panel-body">
			<form id="form-add-coll" class="form-horizontal">
				<div class="form-group">
					<label class="control-label col-sm-4">Collection Name</label>
					<div class="col-sm-5">
						<input class="form-control" type="text" name="name">
					</div>
				</div>
				
				<div class="form-group">
					<label class="control-label col-sm-4">Feilds</label>
					<div class="col-sm-5" id="div-fields"></div>
				</div>
				
				<div class="form-group">
					<label class="control-label col-sm-4">Summary</label>
					<div class="col-sm-5">
						<textarea class="form-control" name="summary"></textarea>
					</div>
				</div>
				
				<div class="form-group">
					<div class="col-sm-12">
						<input type="submit" value="Add" class="btn btn-success">
					</div>
				</div>
			</form>
		</div>
	</div>
</div>


<script>
	(function(){
		var $wrapper = $('#wrapper'),
			$table = $wrapper.find('#table-collections'),
			$form_modify_db = $wrapper.find('#form-modify-db'),
			$form_colls = $wrapper.find('#form-colls'),
			$form_add_coll = $wrapper.find('#form-add-coll'),
			$btn_remove_colls = $wrapper.find('#btn-remove-colls'),
			$btn_modify_colls = $wrapper.find('#btn-modify-colls');
		
		
		var sysFields = ['_id'],
		maxNumUserFields = 4,
		maxNumFields = sysFields.length + maxNumUserFields;
		
		
		// load data
		$.get('/do_check_db', function(reply){
			if (reply['ok']) {
				var db = reply['db'];
				var $tbody = $table.find('tbody').hide();
				_.each(db['_colls'], function(coll){
					$(['<tr>',
						'<td>',
							'<input type="checkbox" name="selected[]" value="'+ coll['_id'] +'">',
						'</td>',
						'<td>',
							'<input class="form-control" type="text" class="input-mini" name="_id[]" value="'+ coll['_id'] +'" readonly>',
						'</td>',
						'<td>',
							'<input class="form-control" type="text" name="name[]" value="'+ coll['name'] +'">',
						'</td>',
						'<td>',
							'<input class="form-control" type="text" value="'+ _(coll['fields']).chain().map(function(val){
							return '`' + val + '`';
						}).reduce(function(sum, val){
							return (sum && sum + ', ') + val;
						}, '').value() +'" readonly>',
						'</td>',
						'<td>',
							'<input class="form-control" type="text" name="summary[]" value="'+ coll['summary'] +'">',
						'</td>',
						'<td>',
							'<button class="btn btn-success" href="check_coll?coll='+ coll['_id'] +'">View</button>',
						'</td>',
					'</tr>'].join('')).appendTo($tbody);
				});
				$tbody.show();
				
				// set default values
				$form_modify_db.find('[name="username"]').attr('value', db['username']);
				$form_modify_db.find('[name="summary"]').text(db['summary']);
			} else {
				$.notify(reply['msg']);
			}
		});
		
		
		// button create
		$table.find('#btn-create').on('click', function(ev){
			$frame.path('create_coll');
		});
		
		
		//form submit
		$form_modify_db.on('submit', function(ev){
			if (! validate()) {
				return false;
			}
			
			$.post('/do_modify_db', $form_modify_db.getFormData(), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.repath();
				}
			});
			
			return false;
			
			function validate(){
				var pass = $form_modify_db.find('[name="password"]').val(),
					pass_again = $form_modify_db.find('#input-again').val();
				if (pass && pass_again !== pass) {
					$.notify('Not Match');
					return false;
				}
				return true;
			}
		});
		
		$btn_remove_colls.on('click', function(ev){
			$.post('/do_remove_colls', $form_colls.getFormData('selected'), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.repath();
				}
			});
			
			return false;
		});
		
		$btn_modify_colls.on('click', function(ev){
			$.post('/do_modify_colls', $form_colls.getFormData(), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.repath();
				}
			});
			
			return false;
		});
		
		
		
		var $div_fields = $form_add_coll.find('#div-fields');
		_.each(sysFields, function(val){
			$div_fields.append(['<div class="input-group">',
				'<span class="input-group-addon">',
					'<input class="tick-toggle" type="checkbox" checked disabled>',
				'</span>',
				'<input class="form-control" type="text" value="'+ val +'" readonly>',
			'</div>'].join(''));
		});
		_.times(maxNumUserFields, function(){
			$div_fields.append(['<div class="input-group">',
				'<span class="input-group-addon">',
					'<input class="tick-toggle" type="checkbox">',
				'</span>',
				'<input class="form-control" type="text" name="fields[]" disabled>',
			'</div>'].join(''));
		});
		$div_fields.find('.tick-toggle').on('change', function(){
			$(this).closest('.input-group').find('[name]').attr('disabled', ! $(this).is(':checked'));
		});
		
		
		$form_add_coll.on('submit', function(ev){
			$.post('/do_add_coll', $form_add_coll.getFormData(), function(reply){
				$.notify(reply['msg']);
				
				if (reply['ok']) {
					$frame.path('check_coll?coll='+ reply['_id']);
				}
			});
			
			return false;
		});
	})();
</script>