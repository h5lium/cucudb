<form id="form-modify">
	<legend>Modify My Account</legend>
	
	<div class="control-group">
		<label>Username</label>
		<div class="controls">
			<input type="text" name="username">
		</div>
	</div>
	
	<div class="control-group">
		<label>Password</label>
		<div class="controls">
			<input type="password" name="password">
		</div>
	</div>
	<div class="control-group">
		<label>Password Again</label>
		<div class="controls">
			<input type="password" id="input-again">
		</div>
	</div>
	
	<div class="control-group">
		<label>Summary</label>
		<div class="controls">
			<textarea name="summary" rows="4" cols="30"></textarea>
		</div>
	</div>
	
	 <div class="control-group">
		<div class="controls">
			<input type="button" id="btn_drop" value="Drop">
			<input type="reset" value="Reset">
			<input type="submit" value="Modify">
		</div>
	</div>
</form>

<table id="table-collections">
	<caption>My Collections</caption>
	<thead>
		<tr>
			<th>Name</th>
			<th>Fields</th>
			<th>Summary</th>
			<th>Action</th>
		</tr>
	</thead>
	<tbody></tbody>
</table>

<hr>
<a href="/">Back</a>

<script src="/plug/jquery/jquery.min.js"></script>
<script src="/plug/underscore/underscore-min.js"></script>
<script src="/js/form.js"></script>
<script>
	$(document).ready(function(){
		// load data
		var $tbody = $('#table-collections>tbody');
		
		var tmp = location.search.match(/[?&]_id=([^&]*)/),
			user_id = tmp? tmp[1]: -1;
		$.get('/do_check_user?_id='+ user_id, function(reply){
			if (reply['ok']) {
				var user = reply['user'];
				$.each(user['_colls'], function(i, coll){
					$(['<tr>',
						'<td>'+ coll['name'] +'</td>',
						'<td>'+ coll['fields'] +'</td>',
						'<td>'+ coll['summary'] +'</td>',
						'<td>'+ '<a href="/check_coll/?_name='+ coll['name'] +'">详细</a>' +'</td>',
					'</tr>'].join('')).appendTo($tbody);
				});
				
				// set default values
				$form.find('[name="username"]').attr('value', user['username']);
				$form.find('[name="password"]').attr('value', user['password']);
				$form.find('[name="summary"]').text(user['summary']);
			} else {
				alert(reply['msg']);
			}
		});
		
		//form submit
		var $form = $('#form-modify');
		$form.find('#btn_drop').on('click', function(){
			$.post('/do_drop/?_id=' + user_id, function(reply){
				alert(reply['msg']);
				
				if (reply['ok']) {
					location.href = '/';
				}
			});
		});
		$form.on('submit', function(ev){
			var $form = $(this);
			
			var pass = $form.find('[name="password"]').val(),
				pass_again = $form.find('#input-again').val();
			if (pass_again !== pass) {
				alert('Not Match');
				return false;
			}
			
			$.post('/do_modify_user', $form.getFormData(), function(reply){
				alert(reply['msg']);
				
				if (reply['ok']) {
					location.reload();
				}
			});
			
			return false;
		});
	});
</script>